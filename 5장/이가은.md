# 5ì¥ ì„œë¹„ìŠ¤ ì¶”ìƒí™”

# 5.1 ì‚¬ìš©ì ë ˆë²¨ ê´€ë¦¬ ê¸°ëŠ¥ ì¶”ê°€

---

- UserDaoëŠ” CRUD ê¸°ì´ˆ ì‘ì—…ë§Œ ê°€ëŠ¥í•¨. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê°–ê³  ìˆì§€ ì•ŠìŒ.
- ì¸í„°ë„· ì„œë¹„ìŠ¤ì˜ ì‚¬ìš©ì ê´€ë¦¬ ê¸°ëŠ¥ì—ì„œ êµ¬í˜„í•´ì•¼ í•  ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
    - ì‚¬ìš©ìì˜ ë ˆë²¨ì€ BASIC, SILVER, GOLD ì„¸ ê°€ì§€ë‹¤.
    - ì‚¬ìš©ìëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê·œì¹™ìœ¼ë¡œ ë ˆë²¨ì´ ìƒìŠ¹í•œë‹¤:
        - ì‹ ê·œ ê°€ì… ì‹œ BASIC ë ˆë²¨ë¡œ ì‹œì‘í•œë‹¤.
        - BASIC ë ˆë²¨ì—ì„œ ë¡œê·¸ì¸ 50íšŒ ì´ìƒ ì‹œ SILVER ë ˆë²¨ì´ ëœë‹¤.
        - SILVER ë ˆë²¨ì—ì„œ ì¶”ì²œ 30íšŒ ì´ìƒ ë°›ìœ¼ë©´ GOLD ë ˆë²¨ì´ ëœë‹¤.
    - ë ˆë²¨ ë³€ê²½ì€ ì •í•´ì§„ ì£¼ê¸°ë¡œ ì¼ê´„ ì²˜ë¦¬ë˜ë©°, ë³€ê²½ ì‘ì—… ì „ê¹Œì§€ëŠ” ì¡°ê±´ì„ ì¶©ì¡±í•´ë„ ë ˆë²¨ì´ ë°”ë€Œì§€ ì•ŠëŠ”ë‹¤.

## 1. í•„ë“œ ì¶”ê°€

- ê° ë ˆë²¨ì„ ì½”ë“œí™” í•´ì„œ ìˆ«ìë¡œ ë„£ì–´ë³´ì.
- ìë°”ì˜ Userì— ì¶”ê°€í•  í”„ë¡œí¼í‹° íƒ€ì…ì€ ìˆ«ìë¡œ í•˜ê²Œ ë˜ë©´ ì•ˆì „í•˜ì§€ ì•ŠìŒ.
- levelì´ intì´ì–´ì„œ ë‹¤ë¥¸ ì¢…ë¥˜ì˜ ì •ë³´ ë„£ëŠ” ì‹¤ìˆ˜ í•´ë„ ì»´íŒŒì¼ëŸ¬ëŠ” ì²´í¬ ëª»í•¨.

â‡’ ENUM ì‚¬ìš©í•˜ì. 

- Level

```java
public enum Level {
	BASIC(1), SILVER(2), G0LD(3);
	
	private final int value;
	
	Level(int value) {
		this.value = value;
	}
	
	public int intValue() {
		return value;
	}
	
	public static Level valueOf(int value) {
		switch(value) {
			case 1: return BASIC;
			case 2: return SILVER;
			case 3: return G0LD;
			default: throw new AssertionError("Unknown value: "+ value);
		}
	}
}
```

- User

```java
class User {
	private static final int BASIC = 1;
	private static final int SILVER = 2;
	private static final int GOLD = 3;
	
	Level level;
	int login;
	int recommend;
	
	public void setLevel(Level level) {
		this.level = level;
	}
	
	public Level getLevel() {
		return level;
	}
	
		public User(String id, String name, String password, Level level, int login, int recommend) {
			this.id = id;
			this.name = name;
			this.password = passworkd;
			this.level = level;
			this.login = login;
			this.recommend = recommend;
	} 
}
```

- UserDaoTest

```java
@Before("")
    public void setUp() {
        this.user1 = new User("gyumee", "ë°•ì„±ì² ", "springnol", Level.BASIC, 1, 1);
        this.user2 = new User("leegw70O", "ì´ê¸¸ì›",	"springno2", Level.GOLD, 50, 10);
        this.user3 = new User("bumjin", "ë°•ë²”ì§„", "springno3", Level.SILVER, 100, 40);
    }
    
    private void checkSameUser(User user1, User user2) {
        assertThat(user1.getId(), is(user2.getId()));
        assertThat(user1.getName(), is(user2.getName()));
        assertThat(user1.getPassword(), is(user2.getPassword()));
        assertThat(user1.getLevel(), is(user2.getLevel()));
        assertThat(user1.getLogin(), is(user2.getLogin()));
        assertThat(user1.getRecommend(), is(user2.getRecommend()));
    }
    
    @Test
    public void addAndGet() {
        ...
        User userget1 = dao.get(user1.getId());
        checkSameUser(userget1, user1);

        User userget2 = dao.get(user2.getId());
        checkSameUser(userget2, user2);
    }
```

- UserDaoJdbc

```java
public class UserDaoJdbc implements UserDao {
  // ...
  private RowMapper<User> userMapper = new RowMapper<User>() {
      @Override
      public User mapRow(ResultSet rs, int rowNum) throws SQLException {
          User user = new User();
          user.setId(rs.getString("id"));
          user.setName(rs.getString("name"));
          user.setPassword(rs.getString("password"));
          user.setLevel(Level.valueOf(rs.getInt("level")));
          user.setLogin(rs.getInt("login"));
          user.setRecommend(rs.getInt("recommend"));
          return user;
      }
  };

  public void add(User user) {
    this.jdbcTemplate.update(
		"insert into users(id, name, password, level, login, recommend) " + 
		"values(?,?,?,?,?,?)", user.getId(), user.getName(), 
		user.getPassword(), user.getLevel().intValue(), 
		user.getLogin(), user.getRecommend());
	}
```

- Levelì€ Enumì´ë¼ì„œ DBì— ì €ì¥ë  ìˆ˜ ì—†ëŠ” SQL íƒ€ì…ì„.
    - Enumê°’ ì €ì¥í•˜ê¸°
        
        â‡’ ì €ì¥ ê°€ëŠ¥í•œ ì •ìˆ˜í˜• ê°’ìœ¼ë¡œ ë³€í™˜ í•„ìš”. â‡’ **intValue**() ì‚¬ìš©
        
    - Enumê°’ ì¡°íšŒí•˜ê¸°
        
        â‡’ valueOf() ì´ìš©í•˜ì—¬ int íƒ€ì… ê°’ì„ Level íƒ€ì…ì˜ Enum ì˜¤ë¸Œì íŠ¸ë¡œ ë§Œë“¤ì–´ setLevel() ë©”ì†Œë“œì— ë„£ì–´ì¤˜ì•¼ í•¨.
        
- ë¹ ë¥´ê²Œ ì‹¤í–‰ ê°€ëŠ¥í•œ í¬ê´„ì  í…ŒìŠ¤íŠ¸ ë§Œë“¤ì–´ë‘ì. ê¸°ëŠ¥ ì¶”ê°€/ìˆ˜ì • ì¼ì–´ë‚  ë•Œ ì˜¤íƒ€ë„ ì°¾ì•„ ì¤„ ìˆ˜ ìˆìŒ.

## 2. ì‚¬ìš©ì ìˆ˜ì • ê¸°ëŠ¥ ì¶”ê°€

ì‚¬ìš©ì ì •ë³´ ì—¬ëŸ¬ ë²ˆ ìˆ˜ì • ê°€ëŠ¥. 

### ìˆ˜ì • ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì¶”ê°€

### UserDaoì™€ UserDaoJdbc ìˆ˜ì •

- UserDao ì¸í„°í˜ì´ìŠ¤ì— update() ì¶”ê°€ (ì•„ë‹ˆë©´ ì»´íŒŒì¼ ì—ëŸ¬ ëœ¸)

```java
public interface UserDao {
	...
	public void update(User user1);
}
```

- UserDaoJdbcì˜ update() ë©”ì†Œë“œëŠ” add()ì™€ ë¹„ìŠ·í•œ ë°©ì‹ìœ¼ë¡œ ë§Œë“¤ì.

```java
public void update(User user) {
	this.jdbcTemplate.update(
		"update users set name = ?, password = ?, level = ?, login = ?, " + 
		"recommend = ? where id = ? ", user.getName(), user.getPassword(), 
		user.getLevel().intValue(), user.getLogin(), user.getRecommend(), 
		user.getId());
}
```

### ìˆ˜ì • í…ŒìŠ¤íŠ¸ ë³´ì™„

1. JdbcTemplateì˜ update()ê°€ ëŒë ¤ì£¼ëŠ” ë¦¬í„´ ê°’ í™•ì¸
    - ì—ëŸ¬ ë°œìƒí•˜ì§€ ì•Šê³  ì§ì ‘ í™•ì¸í•˜ì—¬ ì•Œ ìˆ˜ ìˆìŒ
2. í…ŒìŠ¤íŠ¸ë¥¼ ë³´ê°•í•´ì„œ ì›í•˜ëŠ” ì‚¬ìš©ì ì™¸ì˜ ì •ë³´ëŠ” ë³€ê²½ë˜ì§€ ì•Šì•˜ìŒì„ í™•ì¸

```java
@Test
public void update() {
    // ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œ
    dao.deleteAll();

    // ìƒˆ ì‚¬ìš©ì ì¶”ê°€
    dao.add(user1);

    // í•„ë“œê°’ì„ ë³€ê²½í•œ í›„ ìˆ˜ì • ë©”ì„œë“œ í˜¸ì¶œ
    user1.setName("ì˜¤ë¯¼ê·œ");
    user1.setPassword("springno6");
    user1.setLevel(Level.GOLD);
    user1.setLogin(1000);
    user1.setRecommend(999);

    // ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸
    dao.update(user1);

    // ìˆ˜ì •ëœ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ í™•ì¸
    User user1update = dao.get(user1.getId());
    checkSameUser(user1, user1update);
}

```

## 3. UserService.upgradeLevels()

- ë ˆë²¨ ê´€ë¦¬ ê¸°ëŠ¥ êµ¬í˜„í•˜ê¸°
- ì‚¬ìš©ì ê´€ë¦¬ ë¡œì§? UserService ì— ë‘ì. (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì„œë¹„ìŠ¤ ì œê³µí•œë‹¤ëŠ” ì˜ë¯¸)
    - UserServiceëŠ” ì¸í„°í˜ì´ìŠ¤, userDao ë¹ˆì„ DI ë°›ì•„ ì‚¬ìš©í•˜ê²Œ ë§Œë“¦. ( UserDaoëŠ” ì¸í„°í˜ì´ìŠ¤.)
    - UserServiceTest : UserServiceë¥¼ ìœ„í•œ í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤

### UserService í´ë˜ìŠ¤ì™€ ë¹ˆ ë“±ë¡

```java
public class UserService {
	UserDao userDao; //ì‚¬ìš©í•  UserDao ì˜¤ë¸Œì íŠ¸
	public void setUserDao(UserDao userDao) { 
		this.userDao = userDao; //UserDao ì˜¤ë¸Œì íŠ¸ DI ìœ„í•œ ìˆ˜ì •ì ë©”ì†Œë“œ
	}
}
```

- ì¶”ê°€ì ìœ¼ë¡œ ìŠ¤í”„ë§ ì„¤ì •íŒŒì¼ì— userService ë¹ˆ ì¶”ê°€í•œë‹¤.

### UserServiceTest í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤

```java
@RunWith(SpringJUnit4ClassRunner.class)
@Contextconfiguration(locations="/test-applicationContext.xml") 
public class UserServiceTest { 
	@Autowired
	UserService userService;
}
```

- userService ë¹ˆ ì£¼ì… í…ŒìŠ¤íŠ¸

```java
@Test
public void bean() {
	assertThat(this.userService, is(notNullValue()));
}
```

### upgradeLevels() ë©”ì†Œë“œ

ì‚¬ìš©ì ë ˆë²¨ ê´€ë¦¬ ê¸°ëŠ¥ ë§Œë“¤ê³  í…ŒìŠ¤íŠ¸ ì¶”ê°€

```java
public void upgradeLevels() {
    List<User> users = userDao.getAll();

    for (User user : users) {
        Boolean changed = null; // ë ˆë²¨ì˜ ë³€ê²½ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸

        if (user.getLevel() == Level.BASIC && user.getLogin() >= 50) {
            user.setLevel(Level.SILVER); // BASIC ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ì‘ì—…
            changed = true; // ë ˆë²¨ ë³€ê²½ í”Œë˜ê·¸ ì„¤ì •
        } else if (user.getLevel() == Level.SILVER && user.getRecommend() >= 30) {
            user.setLevel(Level.GOLD); // SILVER ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ì‘ì—…
            changed = true; // ë ˆë²¨ ë³€ê²½ í”Œë˜ê·¸ ì„¤ì •
        } else if (user.getLevel() == Level.GOLD) {
            changed = false; // GOLD ë ˆë²¨ì€ ë³€ê²½ì´ ì¼ì–´ë‚˜ì§€ ì•ŠìŒ
        } else {
            changed = false; // ìœ„ ì¡°ê±´ì— ë§ì§€ ì•Šì„ ê²½ìš° ë³€ê²½ ì—†ìŒ
        }

        if (changed) {
            userDao.update(user); // ë ˆë²¨ì— ë³€ê²½ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ update í˜¸ì¶œ
        }
    }
}

```

- ëª¨ë“  ì‚¬ìš©ì ì •ë³´ë¥¼ DAOì—ì„œ ê°€ì ¸ì˜¤ê³  í•œ ëª…ì”© ë ˆë²¨ ë³€ê²½ ì‘ì—… ìˆ˜í–‰.
- ë ˆë²¨ ë³€ê²½ëëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆëŠ” changed í”Œë˜ê·¸ ì„ ì–¸.
- changed í”Œë˜ê·¸ í™•ì¸í•˜ì—¬ ë ˆë²¨ ë³€ê²½ ìˆì„ ê²½ìš° UserDaoì˜ update() ë¡œ ìˆ˜ì •ì‚¬í•­ DB ë°˜ì˜

### upgradeLevels() í…ŒìŠ¤íŠ¸

ë³€ê²½ì´ ì¼ì–´ë‚˜ì§€ ì•ŠëŠ” GOLD ì œì™¸ ì—…ê·¸ë ˆì´ë“œ ë˜ëŠ” ê²½ìš°/ ì•„ë‹Œ ê²½ìš° í™•ì¸. 

ì—…ê·¸ë ˆì´ë“œ í›„ ì˜ˆìƒëŒ€ë¡œ ê²°ê³¼ ë‚˜ì˜¤ëŠ”ì§€ í™•ì¸í•˜ëŠ” í…ŒìŠ¤íŠ¸.

```java
class UserServiceTest {
	...
	List<User> users;
	
	@Before
	public void setUp() {
		users = Arrays.asList(
				new User("bumjin", "ë°•ë²”ì§„", "p1", Level.BASIC, 49, 0),
				new User("joytouch", "ê°•ëª…ì„±", "p1", Level.BASIC, 50, 0),
				new User("erwins", "ì‹ ìŠ¹í•œ", "p1", Level.SILVER, 60, 29),
				new User("madnite1", "ì´ìƒí˜¸", "p1", Level.SILVER, 60, 30),
				new User("green", "ì˜¤ë¯¼ê·œ", "p1", Level.GOLD, 100, 100)
		);
	}
	
	@Test
	public void upgradeLevels() {
		 userDao.deleteAll();
		 for(User user : users) userDao.add(user);
			 UserService.upgradeLevels();
			 
			 checkLevel(users.get(0), Level.BASIC);
			 checkLevel(users.get(1), Level.SILVER);
			 checkLevel(users.get(2), Level.SILVER);
			 checkLevel(users.get(3), Level.GOLD);
			 checkLevel(users.get(4), Level.GOLD);
	}
	
	private void checkLevel(User user, Level expectedLevel) {
		User userUpdate = userDao.get(user.getId());
		assertThat(userUpdate.getLevel(), is(expectedLevel));
	}
}
```

## 4. UserService.add()

ì²˜ìŒ ê°€ì…í•´ì•¼í•˜ëŠ” ì‚¬ìš©ìëŠ” ê¸°ë³¸ì ìœ¼ë¡œ BASIC ë ˆë²¨ì´ì–´ì•¼ í•¨. 

1. UserDaoJdbcëŠ” ì£¼ì–´ì§„ User ì˜¤ë¸Œì íŠ¸ë¥¼ DBì— ì •ë³´ë¥¼ ë„£ê³  ì½ëŠ” ë°©ë²•ì—ë§Œ ê´€ì‹¬ ê°€ì ¸ì•¼ í•¨.
2. User í´ë˜ìŠ¤ì—ì„œ ì•„ì˜ˆ level í•„ë“œë¥¼ Level.BASIC ì´ˆê¸°í™”ëŠ” ì²˜ìŒ ê°€ì…í•  ë•Œì—ë§Œ ì˜ë¯¸ìˆëŠ” ì •ë³´ì´ê¸°ì— ì´ê±¸ ìœ„í•´ì„œ í´ë˜ìŠ¤ì—ì„œ ì§ì ‘ ì´ˆê¸°í™”ëŠ” ë¬¸ì œìˆìŒ
3. ì‚¬ìš©ì ê´€ë¦¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë‹´ê³  ìˆëŠ” **UserService**ì— ë„£ì.

- í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ : ë ˆë²¨ì´ ë¯¸ë¦¬ ì •í•´ì§„ ê²½ìš° / ë ˆë²¨ì´ ë¹„ì–´ìˆëŠ” ê²½ìš° ê°ê° add() í˜¸ì¶œ í›„ ê²°ê³¼ í™•ì¸
    - UserServiceê°€ UserDao ì œëŒ€ë¡œ ì‚¬ìš©í•˜ëŠ”ì§€ ê²€ì¦ + ë””í´íŠ¸ ë ˆë²¨ ì„¤ì • í›„ UserDao í˜¸ì¶œí•˜ëŠ”ì§€ë„ ê²€ì¦ë¨

```java
@Test
public void add() {
    // ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œ
    userDao.deleteAll();

    // GOLD ë ˆë²¨ ì‚¬ìš©ì
    User userWithLevel = users.get(4); // ì´ë¯¸ GOLD ë ˆë²¨ë¡œ ì§€ì •ëœ ì‚¬ìš©ì
    // ë ˆë²¨ì´ ì—†ëŠ” ì‚¬ìš©ì
    User userWithoutLevel = users.get(0); // ë ˆë²¨ì´ null ìƒíƒœ
    userWithoutLevel.setLevel(null); // ë ˆë²¨ì„ ëª…ì‹œì ìœ¼ë¡œ nullë¡œ ì„¤ì •

    // ì‚¬ìš©ì ì¶”ê°€
    userService.add(userWithLevel); // GOLD ë ˆë²¨ì¸ ì‚¬ìš©ìëŠ” ë ˆë²¨ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ
    userService.add(userWithoutLevel); // ë ˆë²¨ì´ ì—†ëŠ” ì‚¬ìš©ìëŠ” BASICìœ¼ë¡œ ì„¤ì •ë¨

    // ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ ì½ê¸°
    User userWithLevelRead = userDao.get(userWithLevel.getId());
    User userWithoutLevelRead = userDao.get(userWithoutLevel.getId());

    // ì €ì¥ëœ ê²°ê³¼ í™•ì¸
    assertThat(userWithLevelRead.getLevel(), is(userWithLevel.getLevel())); // ê¸°ì¡´ GOLD ë ˆë²¨ ìœ ì§€
    assertThat(userWithoutLevelRead.getLevel(), is(Level.BASIC)); // ë ˆë²¨ì´ ì—†ë˜ ì‚¬ìš©ìëŠ” BASICìœ¼ë¡œ ì„¤ì •ë¨
}

```

## 5. ì½”ë“œ ê°œì„ 

- ì§ˆë¬¸ í•´ë³´ì.
    1. ì½”ë“œ ì¤‘ë³µëœ ë¶€ë¶„ ì—†ëŠ”ê°€?
    2. ì½”ë“œê°€ ë¬´ì—‡ì„ í•˜ëŠ” ê²ƒì¸ì§€ ì´í•´í•˜ê¸° ë¶ˆí¸í•˜ì§€ ì•Šì€ê°€?
    3. ì½”ë“œê°€ ìì‹ ì´ ìˆì–´ì•¼ í•  ìë¦¬ì— ìˆëŠ”ê°€?
    4. ì•ìœ¼ë¡œ ë³€ê²½ì´ ì¼ì–´ë‚œë‹¤ë©´ ì–´ë–¤ ê²ƒì´ ìˆì„ ìˆ˜ ìˆê³ , ê·¸ ë³€í™”ì— ì‰½ê²Œ ëŒ€ì‘í•  ìˆ˜ ìˆê²Œ ì‘ì„±ë˜ì–´ ìˆëŠ”ê°€?

### upgradeLevels()

- ë¬¸ì œì 
    - í˜„ì¬ ë ˆë²¨ê³¼ ì—…ê·¸ë ˆì´ë“œ ì¡°ê±´ ë™ì‹œ ë¹„êµ ë¶€ë¶„ (ë‘ ë‹¨ê³„ ê±¸ì³ ë¹„êµí•´ì•¼ í•¨)
- ë¦¬íŒ©í† ë§

```java
public void upgradeLevels() {
    List<User> users = userDao.getAll();

    for (User user : users) {
        if (canUpgradeLevel(user)) { 
					upgradeLevel(user);
    }
    
    //ì—…ê·¸ë ˆì´ë“œ ê°€ëŠ¥í•œì§€ í™•ì¸
    private boolean canUpgradeLevel(User user) {
			Level currentLevel = user.getLevel();
			switch(currentLevel) {
				case BASICï¼š return (user.getLogin() >= 50);
				case SILVERï¼š return (user.getRecommend() >= 30);
				case GOLDï¼š return false;
				defaultï¼š throw new illegalArgumentException("Unknown Levelï¼š " + 
							currentLevel); // ë‹¤ë£° ìˆ˜ ì—†ëŠ” ë ˆë²¨
							
	
}

```

- ì—…ê·¸ë ˆì´ë“œ ë©”ì†Œë“œ êµ¬ë¦¼

```java
//ì—…ê·¸ë ˆì´ë“œ ì‘ì—…
		private void upgradeLevel(User user) {
			if (user.getLevel() == Level.BASIC) user.setLevel(Level.SILVER);
			else if (user.getLevel() == Level.SILVER) user.setLevel(Level.GOLD); 
			userDao.update(user);
		}
```

â‡’ ë ˆë²¨ ìˆœì„œì™€ ë‹¤ìŒ ë‹¨ê³„ ë ˆë²¨ ë¬´ì—‡ì¸ì§€ ê²°ì •í•˜ëŠ” ì¼ì„ Level(ENUM)ì— ë§¡ê¸°ì. 

### UpgradeLevel() ê°œì„ 

- Level

```java
public enum Level {
	 G0LD(3, null), SILVER(2, GOLD), BASIC(1, SILVER); //ë ˆë²¨ ì •ë³´ ì¶”ê°€
	
	private final int value;
	private final Level next;
	
	Level(int value, Level next) {
		this.value = value;
		this.next = next;
	}
	
	public int intValue() {
		return value;
	}
	
	public Level nextLevel() {
		return this.next;
	}
	
	public static Level valueOf(int value) {
		switch(value) {
			case 1: return BASIC;
			case 2: return SILVER;
			case 3: return G0LD;
			default: throw new AssertionError("Unknown value: "+ value);
		}
	}
}
```

- User

```java
public void upgradeLevel() {
	Level nextLevel = this.level.nextLevel();
	if (nextLevel == null) {
		//ì˜ˆì™¸ ìƒí™© ê²€ì¦
		throw new IllegalStateException(this.level + "ì€ ì—…ê·¸ë ˆì´ë“œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤"); 
	} 
	else {
		 this.level = nextLevel;
	}
}
```

- ê·¸ë˜ì„œ ë°”ë€ upgradeLevel() ë©”ì†Œë“œ

```java
private void upgradeLevel(User user) {
	user.upgradeLevel();
	userDao.update(user);
}
```

- ê°ì²´ì§€í–¥ì  ì½”ë“œëŠ” ë‹¤ë¥¸ ì˜¤ë¸Œì íŠ¸ ë°ì´í„° ê°€ì ¸ì™€ì„œ ì‘ì—…ë³´ë‹¤ëŠ” ê°€ì§€ê³  ìˆëŠ” ì˜¤ë¸Œì íŠ¸ì—ê²Œ ì‘ì—… í•´ë‹¬ë¼ê³  ìš”ì²­í•˜ëŠ” ê²ƒì„.

<aside>
ğŸ’¡

â€œì½”ë“œë¥¼ ë” ê¹”ë”í•˜ê³  ìœ ì—°í•˜ë©´ì„œ ë³€í™”ì— ëŒ€ì‘í•˜ê¸° ì‰½ê³  í…ŒìŠ¤íŠ¸í•˜ê¸° ì¢‹ê²Œ ë§Œë“¤ë ¤ê³  ë…¸ë ¥í•´ì•¼ í•¨â€

</aside>

# 5.2 íŠ¸ëœì­ì…˜ ì„œë¹„ìŠ¤ ì¶”ìƒí™”

---

â€œì •ê¸° ì‚¬ìš©ì ë ˆë²¨ ê´€ë¦¬ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ë„ì¤‘ì— ë„¤íŠ¸ì›Œí¬ê°€ ëŠê¸°ê±°ë‚˜ ì„œë²„ì— ì¥ì• ê°€ ìƒê²¨ì„œ ì‘ì—…ì„ ì™„ë£Œí•  ìˆ˜ ì—†ë‹¤ë©´, ê·¸ë•Œê¹Œì§€ ë³€ê²½ëœ ì‚¬ìš©ìì˜ ë ˆë²¨ì€ ê·¸ëŒ€ë¡œ ë‘˜ê¹Œìš”? ì•„ë‹ˆë©´ ëª¨ë‘ ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë ¤ ë†“ì•„ì•¼ í• ê¹Œìš”?â€

## 1. ëª¨ ì•„ë‹ˆë©´ ë„

### ê°•ì œ ì˜ˆì™¸ ë°œìƒì„ í†µí•œ í…ŒìŠ¤íŠ¸

ì‚¬ìš©ì ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ì‹œë„í•˜ë‹¤ê°€ ì¤‘ê°„ì— ì˜ˆì™¸ ë°œìƒí–ˆì„ ê²½ìš° ê·¸ ì „ ì—…ê·¸ë ˆì´ë“œ í–ˆë˜ ì‚¬ìš©ìë„ ë‹¤ì‹œ ì›ë˜ ìƒíƒœë¡œ ëŒì•„ê°”ëŠ”ì§€ í™•ì¸.

```java
@Test
public void upgradeAllOrNothing() {
    // í…ŒìŠ¤íŠ¸ìš© UserService ê°ì²´ ìƒì„± (ë„¤ ë²ˆì§¸ ì‚¬ìš©ìì˜ IDë¡œ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¤ë„ë¡ ì„¤ì •)
    UserService testUserService = new TestUserService(users.get(3).getId());
    testUserService.setUserDao(this.userDao); // UserDaoë¥¼ DI í•´ì¤Œ

    // ëª¨ë“  ì‚¬ìš©ì ë°ì´í„° ì‚­ì œ í›„ ë‹¤ì‹œ ì¶”ê°€
    userDao.deleteAll();
    for (User user : users) {
        userDao.add(user);
    }

    try {
        // ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ìˆ˜í–‰
        testUserService.upgradeLevels();
        fail("TestUserServiceException expected"); // ì˜ˆì™¸ê°€ ë°œìƒí•˜ì§€ ì•Šìœ¼ë©´ ì‹¤íŒ¨
    } catch (TestUserServiceException e) {
        // ì˜ˆì™¸ ë°œìƒ ì‹œ ì •ìƒ ì§„í–‰
    }

    // ì˜ˆì™¸ê°€ ë°œìƒí•˜ê¸° ì „ì— ë ˆë²¨ì´ ë³€ê²½ë˜ì§€ ì•Šì•˜ìŒì„ í™•ì¸
    checkLevelUpgraded(users.get(1), false);
}

```

### í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ì˜ ì›ì¸

- **íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— ì‹¤íŒ¨ í•¨.**
- ëª¨ë“  ì‚¬ìš©ìì˜ ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œí•˜ëŠ” ì‘ì—…ì¸ upgradeLevels() ë©”ì†Œë“œê°€ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ë™ì‘í•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸.
- â€œ**ì›ìì„±**â€ : ì‘ì—…ì„ ìª¼ê°œì„œ ì‘ì€ ë‹¨ìœ„ë¡œ ë§Œë“¤ ìˆ˜ ì—†ë‹¤
- ì „ì²´ ë‹¤ ì„±ê³µ ë˜ëŠ” ì „ì²´ ë‹¤ ì‹¤íŒ¨.
- **íŠ¸ëœì­ì…˜** : ì¤‘ê°„ ì˜ˆì™¸ ë°œìƒí•´ì„œ ì‘ì—… ì™„ë£Œí•  ìˆ˜ ì—†ë‹¤ë©´ ì´ˆê¸° ìƒíƒœë¡œ ëŒë ¤ë†”ì•¼ í•¨.

## 2. íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •

- ì—¬ëŸ¬ ê°œì˜ SQL ì‚¬ìš©ë˜ëŠ” ì‘ì—…ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì·¨ê¸‰í•´ì•¼ í•˜ëŠ” ê²½ìš°ë„ ì¡´ì¬
    - ex) ê³„ì¢Œì´ì²´, **ë ˆë²¨ ìˆ˜ì • ì‘ì—…**
- ì—¬ëŸ¬ ê°œì˜ SQLë¬¸ì´ ìˆëŠ” í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ì—ì„œëŠ” DBì—ì„œ ìˆ˜í–‰ë˜ê¸° ì „ì— ë¬¸ì œ ë°œìƒí•œ ê²½ìš° ì•ì—ì„œ ì²˜ë¦¬í•œ SQL ì‘ì—…ë„ ì·¨ì†Œ ì‹œì¼œì•¼ í•¨!!
    - ì´ ë•Œ ì·¨ì†Œ ì‘ì—… : â€œ**íŠ¸ëœì­ì…˜ ë¡¤ë°±â€**
- ëª¨ë‘ ì„±ê³µì ìœ¼ë¡œ ë§ˆë¬´ë¦¬ ë˜ì—ˆë‹¤ ì•Œë¦¼
    - ì‘ì—… í™•ì • : **â€œíŠ¸ëœì­ì…˜ ì»¤ë°‹â€**

### JDBC íŠ¸ëœì­ì…˜ì˜ íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì •

- ëª¨ë“  íŠ¸ëœì­ì…˜ì€ ì‹œì‘ì§€ì ê³¼ ëë‚˜ëŠ” ì§€ì ì´ ìˆìŒ.
- ëë‚˜ëŠ” ë°©ë²• ë‘ê°€ì§€
    - ë¡¤ë°± : ëª¨ë“  ì‘ì—… ë¬´íš¨í™”
    - ì»¤ë°‹ : ëª¨ë“  ì‘ì—… í™•ì •

- íŠ¸ëœì­ì…˜ ì‚¬ìš©í•œ JDBC ì½”ë“œ

```java
Connection c = dataSource.getConnection(); // DB ì—°ê²° ìƒì„±
c.setAutoCommit(false); // íŠ¸ëœì­ì…˜ ì‹œì‘

try {
    // ì²« ë²ˆì§¸ ì‘ì—…: users í…Œì´ë¸” ì—…ë°ì´íŠ¸
    PreparedStatement st1 = c.prepareStatement("update users ...");
    st1.executeUpdate();

    // ë‘ ë²ˆì§¸ ì‘ì—…: users í…Œì´ë¸” ì‚­ì œ
    PreparedStatement st2 = c.prepareStatement("delete users ...");
    st2.executeUpdate();

    c.commit(); // íŠ¸ëœì­ì…˜ ì»¤ë°‹
} catch (Exception e) {
    c.rollback(); // íŠ¸ëœì­ì…˜ ë¡¤ë°±
    throw e; // ì˜ˆì™¸ë¥¼ ë‹¤ì‹œ ë˜ì§
} finally {
    c.close(); // ì—°ê²° ë‹«ê¸°
}

```

- JDBC íŠ¸ëœì­ì…˜
    - í•˜ë‚˜ì˜ Connection ê°€ì ¸ì™€ì„œ ì‚¬ìš©í•˜ë‹¤ê°€ ë‹«ëŠ” ì‚¬ì´ì—ì„œ ì¼ì–´ë‚¨
        - ì´ìœ  : íŠ¸ëœì­ì…˜ ì‹œì‘-ì¢…ë£Œ : Connection ì˜¤ë¸Œì íŠ¸ í†µí•´ ì´ë¤„ì§
        - JDBCì—ì„œ íŠ¸ëœì­ì…˜ ì‹œì‘í•˜ë ¤ë©´ ìë™ì»¤ë°‹ ì˜µì…˜ false ì„¤ì •í•˜ê¸°
    - DB ì‘ì—… ìˆ˜í–‰ ì§í›„ ìë™ ì»¤ë°‹í•¨

### UserServiceì™€ UserDaoì˜ íŠ¸ëœì­ì…˜ ë¬¸ì œ

- upgradeLevels()ì—ëŠ” íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ì§€ ì•Šì€ ì´ìœ 
    - ì½”ë“œì—ì„œ íŠ¸ëœì­ì…˜ ì‹œì‘ / ì»¤ë°‹ / ë¡¤ë°±í•˜ëŠ” â€œ**íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì • ì½”ë“œ**â€ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ!
- íŠ¸ëœì­ì…˜ì€ ì»¤ë„¥ì…˜ë³´ë‹¤ ì¡´ì¬ ë²”ìœ„ê°€ ì§§ì•„ì„œ JdbcTemplate ë©”ì†Œë“œ ì‚¬ìš©í•˜ëŠ” UserDaoëŠ” ê° ë©”ì†Œë“œë§ˆë‹¤ í•˜ë‚˜ì”©ì˜ ë…ë¦½ì ì¸ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì‹¤í–‰ë  ìˆ˜ë°–ì— ì—†ìŒ
- ì—¬ëŸ¬ ë²ˆ DB ì—…ë°ì´íŠ¸ í•´ì•¼í•˜ëŠ” ì‘ì—…ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë§Œë“¤ë ¤ë©´ DB ì»¤ë„¥ì…˜ë„ í•˜ë‚˜ë§Œ ì‚¬ìš©ë¼ì•¼ í•¨!

### ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë‚´ì˜ íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •

- UserServiceì™€ UserDaoë¥¼ ê·¸ëŒ€ë¡œ ë‘” ì±„ë¡œ íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ë ¤ë©´ ê²°êµ­ íŠ¸ëœì­ì…˜ì˜ ê²½ê³„ì„¤ì • ì‘ì—…ì„ UserService ìª½ìœ¼ë¡œ ê°€ì ¸ì™€ì•¼ í•¨.
    - ì´ìœ  : upgradeLevels() ë©”ì†Œë“œ ì‹œì‘ê³¼ í•¨ê»˜ íŠ¸ëœì­ì…˜ì´ ì‹œì‘í•˜ê³  ë©”ì†Œë“œ ë¹ ì ¸ ë‚˜ì˜¬ ë•Œ íŠ¸ëœì­ì…˜ ì¢…ë£Œ ë¼ì•¼ í•¨!!

- íŠ¸ëœì­ì…˜ ì‚¬ìš©í•˜ëŠ” ì „í˜•ì ì¸ JDBC  ì½”ë“œ êµ¬ì¡°

```java
public void upgradeLevels() throws Exception {
	(1) DB Connection ìƒì„±
	(2) íŠ¸ëœì­ì…˜ ì‹œì‘
	try {
 		(3) DAO ë©”ì†Œë“œ í˜¸ì¶œ
		(4) íŠ¸ëœì­ì…˜ ì»¤ë°‹
	}
 	catch(Exception e) {
 		(5) íŠ¸ëœì­ì…˜ ë¡¤ë°±
		throw eï¼›
	}
 finally {
 		(6) DB Connection ì¢…ë£Œ
 	}
}
```

- UserServiceì—ì„œ ë§Œë“  Connection ì˜¤ë¸Œì íŠ¸ë¥¼ UserDaoì—ì„œ ì‚¬ìš©í•˜ë ¤ë©´ DAO ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•  ë•Œë§ˆë‹¤ Connection ì˜¤ë¸Œì íŠ¸ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•´ì¤˜ì•¼ í•¨.
- íŠ¸ëœì­ì…˜ ë‹´ê³  ìˆëŠ” Connection ê³µìœ í•˜ë ¤ë©´ UserServiceì˜ ë©”ì†Œë“œ ì‚¬ì´ì—ë„ ê°™ì€ Connection ì˜¤ë¸Œì íŠ¸ ì‚¬ìš©í•˜ë„ë¡ íŒŒë¼ë¯¸í„°ë¡œ connectionì„ ì „ë‹¬í•´ì¤˜ì•¼ í•¨!!
    
    â‡’ Conncetion ì˜¤ë¸Œì íŠ¸ ì „ë‹¬í•´ì„œ ì‚¬ìš©í•˜ë©´ UserServiceì˜ upgradeLevels()ì—ì„œ ì‹œì‘í•œ íŠ¸ëœì­ì…˜ì— UserDao ë©”ì†Œë“œë“¤ë„ ì°¸ì—¬ ê°€ëŠ¥í•´ì§!
    

### UserService íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì •ì˜ ë¬¸ì œì 

- íŠ¸ëœì­ì…˜ ë¬¸ì œ í•´ê²°í–ˆì§€ë§Œ ìƒˆë¡œìš´ ë¬¸ì œ ë°œìƒ!!
1. DB ì»¤ë„¥ì…˜ ë¹„ë¡¯í•œ JdbcTemplate ë” ì´ìƒ í™œìš© ë¶ˆê°€ëŠ¥. 
2. DAO ë©”ì†Œë“œì™€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë‹´ê³  ìˆëŠ” UserService ë©”ì†Œë“œì— Connection íŒŒë¼ë¯¸í„°ê°€ ì¶”ê°€ë¼ì•¼ í•¨.  â‡’ íŒŒë¼ë¯¸í„°ë¡œ ì§€ì €ë¶„í•´ì§
3. Connection íŒŒë¼ë¯¸í„°ê°€ UserDao ì¸í„°í˜ì´ìŠ¤ ë©”ì†Œë“œì— ì¶”ê°€ë˜ë©´ UserDaoëŠ” ë” ì´ìƒ ë°ì´í„° ì•¡ì„¸ìŠ¤ ê¸°ìˆ ì— ë…ë¦½ì ì¼ ìˆ˜ ì—†ìŒ
    - JPAë‚˜ í•˜ì´ë²„ë„¤ì´íŠ¸ë¡œ UserDaoì˜ êµ¬í˜„ ë°©ì‹ì„ ë³€ê²½í•˜ë ¤ê³  í•˜ë©´ Connection ëŒ€ì‹  EntityManagerë‚˜ Session ì˜¤ë¸Œì íŠ¸ë¥¼ UserDao ë©”ì†Œë“œê°€ ì „ë‹¬ë°›ë„ë¡ í•´ì•¼ ë˜ëŠ”ë°, ì´ëŸ¬ë©´ UserDao ì¸í„°í˜ì´ìŠ¤ ë°”ë€Œë©´ì„œ UserServiceë„ ìˆ˜ì •í•´ì•¼ í•¨
4. DAO ë©”ì†Œë“œì— Connection íŒŒë¼ë¯¸í„°ë¥¼ ë°›ê²Œ í•˜ë©´ í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œë„ ì§ì ‘ Connection ì˜¤ë¸Œì íŠ¸ë¥¼ ì¼ì¼ì´ ë§Œë“¤ì–´ì„œ DAO ë©”ì†Œë“œ í˜¸ì¶œí•˜ë„ë¡ ë³€ê²½í•´ì•¼ í•¨

## 3. íŠ¸ëœì­ì…˜ ë™ê¸°í™”

ê¹”ë” ì½”ë“œ vs íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ ????

â‡’ ìŠ¤í”„ë§ì€ í•´ê²°í•œë‹¤.

### Connection íŒŒë¼ë¯¸í„° ì œê±°

DAO í˜¸ì¶œí•  ë•Œ Connection ì‚¬ìš©í•˜ëŠ” ê±´ í”¼í•˜ê³  ì‹¶ìŒ

- íŠ¸ëœì­ì…˜ ë™ê¸°í™” : UserServiceì—ì„œ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê¸° ìœ„í•´ ë§Œë“  Connection ì˜¤ë¸Œì íŠ¸ë¥¼ íŠ¹ë³„í•œ ì €ì¥ì†Œì— ë³´ê´€í•´ë‘ê³ , ì´í›„ì— í˜¸ì¶œë˜ëŠ” DAOì˜ ë©”ì†Œë“œì—ì„œëŠ” ì €ì¥ëœ Connectionì„ ê°€ì ¸ë‹¤ê°€ ì‚¬ìš©í•˜ê²Œ í•˜ëŠ” ê²ƒ
    
    = DAOê°€ ì‚¬ìš©í•˜ëŠ” JdbcTemplateì´ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë°©ì‹ì„ ì´ìš©í•˜ë„ë¡ í•˜ëŠ” ê²ƒ. 
    
- ê³¼ì •
    - íŠ¸ëœì­ì…˜ ì‹œì‘:
        - `UserService`ì—ì„œ **Connection**ì„ ìƒì„±í•˜ê³  **íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì €ì¥ì†Œ**ì— ì €ì¥.
        - `setAutoCommit(false)`ë¡œ íŠ¸ëœì­ì…˜ ì‹œì‘.
    - DAO ì‘ì—… ìˆ˜í–‰:
        - DAOì˜ `update()` ë©”ì„œë“œëŠ” **JdbcTemplate**ì„ í†µí•´ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì €ì¥ì†Œì—ì„œ **Connection**ì„ ê°€ì ¸ì˜´.
        - ë™ì¼í•œ `Connection`ì„ ì‚¬ìš©í•´ SQL ì‘ì—…(ì˜ˆ: `update`, `delete`)ì„ ì‹¤í–‰.
    - ì‘ì—… ì§€ì†:
        - `UserService`ëŠ” ì—¬ëŸ¬ DAO ì‘ì—…ì„ í˜¸ì¶œí•˜ë©°, ë™ì¼í•œ íŠ¸ëœì­ì…˜ ë²”ìœ„ ë‚´ì—ì„œ ì‘ì—…ì„ ì²˜ë¦¬.
    - íŠ¸ëœì­ì…˜ ì¢…ë£Œ:
        - ëª¨ë“  ì‘ì—…ì´ ì„±ê³µí•˜ë©´ `commit()` í˜¸ì¶œë¡œ íŠ¸ëœì­ì…˜ í™•ì •.
        - ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ `rollback()` í˜¸ì¶œë¡œ íŠ¸ëœì­ì…˜ ì·¨ì†Œ.
    - Connection ì •ë¦¬:
        - íŠ¸ëœì­ì…˜ ì¢…ë£Œ í›„ `Connection`ì€ ë‹«í˜.

â‡’ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ê¸°ë²• ì‚¬ìš©ì‹œ íŒŒë¼ë¯¸í„°ë¥¼ í†µí•´ ì¼ì¼ì´ Connection ì˜¤ë¸Œì íŠ¸ ì „ë‹¬í•  í•„ìš” ì—†ì–´ì§!

### íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì ìš©

- ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ì•ˆì „í•œ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë°©ë²• êµ¬í˜„í•˜ê¸° ì–´ë ¤ì›€
- ê·¸ëŸ¬ë‚˜ ìŠ¤í”„ë§ì€ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ê¸°ëŠ¥ì„ ì§€ì›í•˜ëŠ” ê°„ë‹¨í•œ ìœ í‹¸ë¦¬í‹° ë©”ì†Œë“œ ì œê³µí•¨

```java
private DataSource dataSource;

public void setDataSource(DataSource dataSource) {
    this.dataSource = dataSource; // DataSource ì„¤ì • ë©”ì„œë“œ
}

public void upgradeLevels() throws Exception {
    // íŠ¸ëœì­ì…˜ ë™ê¸°í™” ê´€ë¦¬ìë¥¼ ì´ìš©í•´ ë™ê¸°í™” ì´ˆê¸°í™”
    TransactionSynchronizationManager.initSynchronization();
    Connection c = DataSourceUtils.getConnection(dataSource); // DataSourceì—ì„œ Connection ê°€ì ¸ì˜¤ê¸°
    c.setAutoCommit(false); // íŠ¸ëœì­ì…˜ ì‹œì‘

    try {
        // ì‚¬ìš©ì ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì™€ ì—…ê·¸ë ˆì´ë“œ ì²˜ë¦¬
        List<User> users = userDao.getAll();
        for (User user : users) {
            if (canUpgradeLevel(user)) {
                upgradeLevel(user); // ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ìˆ˜í–‰
            }
        }
        c.commit(); // íŠ¸ëœì­ì…˜ ì»¤ë°‹
    } catch (Exception e) {
        c.rollback(); // íŠ¸ëœì­ì…˜ ë¡¤ë°±
        throw e;
    } finally {
        // ë¦¬ì†ŒìŠ¤ ì •ë¦¬
        DataSourceUtils.releaseConnection(c, dataSource); // Connection í•´ì œ
        TransactionSynchronizationManager.unbindResource(dataSource); // ë™ê¸°í™” í•´ì œ
        TransactionSynchronizationManager.clearSynchronization(); // ë™ê¸°í™” ì´ˆê¸°í™” ì •ë¦¬
    }
}

```

- JDBCì˜ íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì • ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•´ íŠ¸ëœì­ì…˜ ì´ìš©í•˜ëŠ” ì „í˜•ì ì¸ ì½”ë“œì— ê°„ë‹¨í•œ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì‘ì—… ë¶™ì—¬ì¤Œ
    
    â‡’ Connection íŒŒë¼ë¯¸í„° ë¬¸ì œ í•´ê²°
    

### JdbcTemplateê³¼ íŠ¸ëœì­ì…˜ ë™ê¸°í™”

JdbcTemplate ë™ì‘ë°©ì‹

JDBC ì‘ì—…ì˜ í…œí”Œë¦¿ ë©”ì†Œë“œë¥¼ í˜¸ì¶œì‹œ ì§ì ‘ Connection ìƒì„±/ì¢…ë£Œ ëª¨ë‘ ë‹´ë‹¹

## 4. íŠ¸ëœì­ì…˜ ì„œë¹„ìŠ¤ ì¶”ìƒí™”

### ê¸°ìˆ ê³¼ í™˜ê²½ì— ì¢…ì†ë˜ëŠ” íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì • ì½”ë“œ

- í•œ ê°œ ì´ìƒì˜ DB ì‘ì—…ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë§Œë“œëŠ” ê²ƒì€ ë¶ˆê°€ëŠ¥í•¨
    - ë¡œì»¬ íŠ¸ëœì­ì…˜ì€ í•˜ë‚˜ì˜ DB Connectionì— ì¢…ì†ë˜ê¸° ë•Œë¬¸
- â€œ**ê¸€ë¡œë²Œ íŠ¸ëœì­ì…˜**â€ ë°©ì‹ : ì—¬ëŸ¬ ê°œ DB ì°¸ì—¬í•˜ëŠ” ì‘ì—…ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆìŒ! **JTAë¥¼ ì‚¬ìš©í•´ì•¼ í•¨**
- JTAë¥¼ ì´ìš©í•œ íŠ¸ëœì­ì…˜ ì½”ë“œ êµ¬ì¡°

```java
InitialContext ctx = new InitialContext(); // JNDI ì´ˆê¸° ì»¨í…ìŠ¤íŠ¸ ìƒì„±
UserTransaction tx = (UserTransaction) ctx.lookup("java:comp/UserTransaction"); // JNDIë¥¼ í†µí•´ UserTransaction ê°ì²´ ê°€ì ¸ì˜¤ê¸°

tx.begin(); // íŠ¸ëœì­ì…˜ ì‹œì‘
Connection c = dataSource.getConnection(); // JNDIë¡œ ê°€ì ¸ì˜¨ DataSourceì—ì„œ Connection ìƒì„±

try {
    // ë°ì´í„° ì•¡ì„¸ìŠ¤ ì½”ë“œ
    tx.commit(); // íŠ¸ëœì­ì…˜ ì»¤ë°‹
} catch (Exception e) {
    tx.rollback(); // íŠ¸ëœì­ì…˜ ë¡¤ë°±
    throw e; // ì˜ˆì™¸ë¥¼ ë‹¤ì‹œ ë˜ì§
} finally {
    c.close(); // Connection ë‹«ê¸°
}

```

ê·¸ëŸ¬ë‚˜ í•˜ì´ë²„ë„¤ì´íŠ¸ ì´ìš©í•œ íŠ¸ëœì­ì…˜ ê´€ë¦¬ ì½”ë“œëŠ” JDBCë‚˜ JTA ì½”ë“œì™€ ë‹¤ë¦„. 

- Connectionì„ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ, Session  ì‚¬ìš©
- ë…ìì  íŠ¸ëœì­ì…˜ ê´€ë¦¬ API ì‚¬ìš©

â‡’ ì‚¬ìš©í•˜ë ¤ë©´ í•˜ì´ë²„ë„¤ì´íŠ¸ Sessionê³¼ Transation ì˜¤ë¸Œì íŠ¸ ì‚¬ìš©í•˜ëŠ” íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì • ì½”ë“œë¡œ ë³€ê²½í•´ì•¼ í•¨.

### íŠ¸ëœì­ì…˜ APIì˜ ì˜ì¡´ê´€ê³„ ë¬¸ì œì™€ í•´ê²°ì±…

- íŠ¹ì • ë°ì´í„° ì•¡ì„¸ìŠ¤ ê¸°ìˆ ì— ì¢…ì†ë˜ëŠ” êµ¬ì¡°ê°€ ë˜ëŠ” ë¬¸ì œê°€ ë‹¤ì‹œ ìƒê¹€ ..
- ì¶”ìƒí™”ë¥¼ í†µí•´ í•˜ìœ„ ì‹œìŠ¤í…œì˜ ê³µí†µì ì„ ë½‘ì•„ë‚´ì„œ ë¶„ë¦¬ì‹œì¼œ ì¼ê´€ëœ ë°©ë²•ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ í•˜ì!!

### ìŠ¤í”„ë§ì˜ íŠ¸ëœì­ì…˜ ì„œë¹„ìŠ¤ ì¶”ìƒí™”

- ìŠ¤í”„ë§ì€ íŠ¸ëœì­ì…˜ ì¶”ìƒí™” ê¸°ìˆ  ì œê³µí•¨
    
    â‡’ ê° ê¸°ìˆ  íŠ¸ëœì­ì…˜ API ì‚¬ìš©í•˜ì§€ ì•Šê³ ë„ ì¼ê´€ëœ ë°©ì‹ìœ¼ë¡œ íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì • ì‘ì—… ê°€ëŠ¥í•¨
    
- ìŠ¤í”„ë§ì˜ íŠ¸ëœì­ì…˜ ì¶”ìƒí™” APIë¥¼ ì ìš©í•œ upgradeLevels()

```java
public void upgradeLevels() {
    // íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € ìƒì„± (JDBC íŠ¸ëœì­ì…˜ ì¶”ìƒí™”)
    PlatformTransactionManager transactionManager = new DataSourceTransactionManager(dataSource);

    // íŠ¸ëœì­ì…˜ ì‹œì‘
    TransactionStatus status = transactionManager.getTransaction(new DefaultTransactionDefinition());

    try {
        // ì‚¬ìš©ì ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì™€ ì—…ê·¸ë ˆì´ë“œ ì‘ì—… ìˆ˜í–‰
        List<User> users = userDao.getAll();
        for (User user : users) {
            if (canUpgradeLevel(user)) {
                upgradeLevel(user); // ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ
            }
        }
        transactionManager.commit(status); // íŠ¸ëœì­ì…˜ ì»¤ë°‹
    } catch (RuntimeException e) {
        transactionManager.rollback(status); // íŠ¸ëœì­ì…˜ ë¡¤ë°±
        throw e; // ì˜ˆì™¸ë¥¼ ë‹¤ì‹œ ë˜ì§
    }
}

```

### íŠ¸ëœì­ì…˜ ê¸°ìˆ  ì„¤ì •ì˜ ë¶„ë¦¬

- íŠ¸ëœì­ì…˜ ì¶”ìƒí™” API ì ìš©í•œ UserService ì½”ë“œë¥¼ JTAë¥¼ ì´ìš©í•˜ëŠ” ê¸€ë¡œë²Œ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë³€ê²½í•˜ë ¤ë©´?
    - PlatformTransactionManager êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ DataSourceTransactionManagerì—ì„œ JTATransactionManagerë¡œ ë°”ê¿”ì£¼ê¸°
    
    ```java
    // JTAë¡œ ë°”ê¾¸ê¸° ìœ„í•œ upgradeLevels() ìˆ˜ì •
    PlatformTransactionManager txManager = new JTATrasactionManager();
    ```
    

- í•˜ì´ë²„ë„¤ì´íŠ¸ë¡œ UserDao êµ¬í˜„ â‡’ HibernateTransactionManager ì‚¬ìš© (JTATransactionManager ëŒ€ì‹ )

- ê·¼ë°, ì´ë ‡ê²Œ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € êµ¬í˜„ í´ë˜ìŠ¤ ì¤‘ ì–´ë–¤ ê²ƒì„ ì‚¬ìš©í• ì§€ UserService ì½”ë“œê°€ ì•Œê³  ìˆìœ¼ë©´ DI ì›ì¹™ ìœ„ë°°ë¨.

â‡’ ì»¨í…Œì´ë„ˆë¥¼ í†µí•´ ì™¸ë¶€ì—ì„œ ì œê³µë°›ê²Œ í•˜ëŠ” ìŠ¤í”„ë§ DI ë°©ì‹ìœ¼ë¡œ ë³€ê²½í•˜ê¸°!

UserServiceì—ëŠ” PlatformTransactionManager ì¸í„°í˜ì´ìŠ¤ íƒ€ì…ì˜ ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ë¥¼ ì„ ì–¸í•˜ê³ , ìˆ˜ì •ì ë©”ì†Œë“œë¥¼ ì¶”ê°€í•´ì„œ DIê°€ ê°€ëŠ¥í•˜ê²Œ í•¨

- UserService

```java
public class UserService {
    // íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì˜ì¡´ì„± ì£¼ì…ìœ¼ë¡œ ê´€ë¦¬
    private PlatformTransactionManager transactionManager;

    // íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € ì„¤ì • ë©”ì„œë“œ
    public void setTransactionManager(PlatformTransactionManager transactionManager) {
        this.transactionManager = transactionManager;
    }

    public void upgradeLevels() {
        // íŠ¸ëœì­ì…˜ ì‹œì‘
        TransactionStatus status = this.transactionManager.getTransaction(new DefaultTransactionDefinition());

        try {
            // ì‚¬ìš©ì ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì™€ ì—…ê·¸ë ˆì´ë“œ ì‘ì—… ìˆ˜í–‰
            List<User> users = userDao.getAll();
            for (User user : users) {
                if (canUpgradeLevel(user)) {
                    upgradeLevel(user); // ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ
                }
            }
            this.transactionManager.commit(status); // íŠ¸ëœì­ì…˜ ì»¤ë°‹
        } catch (RuntimeException e) {
            this.transactionManager.rollback(status); // íŠ¸ëœì­ì…˜ ë¡¤ë°±
            throw e; // ì˜ˆì™¸ë¥¼ ë‹¤ì‹œ ë˜ì§
        }
    }

}

```

# 5.3 ì„œë¹„ìŠ¤ ì¶”ìƒí™”ì™€ ë‹¨ì¼ ì±…ì„ ì›ì¹™

---

### ìˆ˜ì§, ìˆ˜í‰ ê³„ì¸µ êµ¬ì¡°ì™€ ì˜ì¡´ê´€ê³„

- â€œ**ìŠ¤í”„ë§**â€œì€ ê²°í•©ë„ ë‚®ê³  ì„œë¡œ ì˜í–¥ ì£¼ì§€ ì•Šê³  ììœ ë¡­ê²Œ í™•ì¥ë  ìˆ˜ ìˆëŠ” êµ¬ì¡°ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë„ë¡ í•¨!
- ê´€ì‹¬, ì±…ì„, ì„±ê²©ì´ ë‹¤ë¥¸ ì½”ë“œë¥¼ ê¹”ë”í•˜ê²Œ ë¶„ë¦¬í•˜ê¸°!!

### ë‹¨ì¼ ì±…ì„ ì›ì¹™

: í•˜ë‚˜ì˜ ëª¨ë“ˆì€ í•œ ê°€ì§€ ì±…ì„ì„ ê°€ì ¸ì•¼ í•¨.

- ì¥ì 
    - ì–´ë–¤ ë³€ê²½ì´ í•„ìš”í•  ë•Œ ìˆ˜ì • ëŒ€ìƒì´ ëª…í™•í•´ì§

<aside>
ğŸ’¡

**ë…¸ë ¥í•˜ì**

1. ì±…ì„ê³¼ ê´€ì‹¬ì´ ë‹¤ë¥¸ ì½”ë“œë¥¼ ë¶„ë¦¬í•˜ì
2. ì„œë¡œ ì˜í–¥ ì£¼ì§€ ì•Šë„ë¡ ë‹¤ì–‘í•œ ì¶”ìƒí™” ê¸°ë²• ë„ì…í•˜ì
3. ê¸°ëŠ¥ì´ ë™ì‘í•œë‹¤ê³  í•´ì„œ ë§Œì¡±í•˜ì§€ ë§ê³  ê³„ì†í•´ì„œ ì½”ë“œë¥¼ ê°œì„ í•˜ê³  ë‹¤ë“¬ì
4. DIì˜ ì›ë¦¬ë¥¼ ì˜ í™œìš©í•˜ì
</aside>